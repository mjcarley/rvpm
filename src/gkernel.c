/* This file is part of RVPM, a library for the Reformulated Vortex
 * Particle Method of Alvarez and Ning (see README.md and
 * documentation for references)
 *
 * Copyright (C) 2024 Michael Carley
 *
 * RVPM is free software: you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version. RVPM is distributed in the
 * hope that it will be useful, but WITHOUT ANY WARRANTY; without even
 * the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
 * PURPOSE.  See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with RVPM.  If not, see <https://www.gnu.org/licenses/>.
 */

#define wbfmm_tree_point_index(_t,_i)			\
  ((RVPM_REAL *)(&((_t)->points[(_i)*((_t)->pstr)])))

#ifdef HAVE_CONFIG_H
#include <config.h>
#endif /*HAVE_CONFIG_H*/

#include <stdio.h>
#include <math.h>

#include <glib.h>

#include "rvpm-private.h"

#define RVPM_GAUSS_FIT_ORDER 10

#ifdef RVPM_SINGLE_PRECISION
#define RVPM_GAUSS_FIT_CUTOFF 4.2
#else
#define RVPM_GAUSS_FIT_CUTOFF 6.2999999999999998e+00
#endif

#define RVPM_GAUSS_FIT_INTERVAL_NUMBER 21

#ifdef RVPM_SINGLE_PRECISION

gfloat RVPM_GAUSS_FIT_COEFFICIENTS_F[] = {
  1.7613787358103880e-03,
  2.6366884350949244e-03,
  1.0454675764299665e-03,
  1.6787491700789148e-04,
  -2.5264324554941617e-06,
  -2.4063469963328620e-07,
  3.0443457338380497e-09,
  2.0441077311708633e-10,
  -2.4439314287583170e-12,
  -1.2594270244747906e-13,
  2.1073202186725180e-02,
  1.8040106402925450e-02,
  2.6762966814901285e-03,
  9.4658574929273881e-05,
  -6.2064618110174720e-06,
  -1.1139027972558585e-07,
  7.0994546717134677e-09,
  6.9549355163900375e-11,
  -5.3884650214053311e-12,
  -2.7043298156392836e-14,
  8.0896591449807043e-02,
  4.2198615882500873e-02,
  3.1738064924145769e-03,
  -1.2901299030215751e-05,
  -6.6741289620031450e-06,
  6.2815226553950001e-08,
  6.6518463751052968e-09,
  -9.5514170184163302e-11,
  -4.2724671023286477e-12,
  8.1906703641720924e-14,
  1.8900768314985128e-01,
  6.5300767764975037e-02,
  2.4447615126319102e-03,
  -1.0211085790586826e-04,
  -4.1046827724988690e-06,
  1.7807069131840770e-07,
  2.5882601867310841e-09,
  -1.7448232858541247e-10,
  -4.8014647813232610e-13,
  1.1279727152313512e-13,
  3.3468622746598098e-01,
  7.9125446805685673e-02,
  9.4932768929731901e-04,
  -1.3756589543467701e-04,
  -3.1172204473239873e-07,
  1.8333409020875048e-07,
  -1.9534175998980886e-09,
  -1.3270843868262717e-10,
  2.7556457116162393e-12,
  5.7612248305360931e-14,
  4.9541431412724390e-01,
  8.0288758757094708e-02,
  -6.2161763768107112e-04,
  -1.1683256901100503e-04,
  2.6426624093689456e-06,
  1.0316235243001958e-07,
  -4.2380071507697183e-09,
  -2.7350954834304275e-11,
  3.3586078362901618e-12,
  -2.0342061368694430e-14,
  6.4716711335643518e-01,
  7.0547112187878167e-02,
  -1.7199401207048659e-03,
  -6.3625145540924244e-05,
  3.6851078647148761e-06,
  3.3164721045808589e-09,
  -3.6882404352844844e-09,
  5.7967197708563842e-11,
  1.7467916002544826e-12,
  -5.8211768738658525e-14,
  7.7277713799500702e-01,
  5.4712841020054449e-02,
  -2.1413356796775584e-03,
  -8.3020899384056435e-06,
  3.0219933119579600e-06,
  -6.1376968315401953e-08,
  -1.6010091696827544e-09,
  8.0459006124300464e-11,
  -2.5601742947856110e-13,
  -4.4203529725450605e-14,
  8.6526907802187802e-01,
  3.7902455551785771e-02,
  -1.9961057182320109e-03,
  2.8874008636403660e-05,
  1.5823438290096802e-06,
  -7.4969505702363048e-08,
  3.3840428237397189e-10,
  5.2777970882544879e-11,
  -1.2608802890667903e-12,
  -8.7096996281843534e-15,
  9.2643416965005954e-01,
  2.3641026085401105e-02,
  -1.5445926960533374e-03,
  4.3055934477043144e-05,
  2.5967414952754452e-07,
  -5.3794764352105287e-08,
  1.2387284753501148e-09,
  1.2336420773806368e-11,
  -1.1200040894721042e-12,
  1.5998313784848505e-14,
  9.6299836395755101e-01,
  1.3350638089545397e-02,
  -1.0331044579833914e-03,
  4.0270344158166435e-05,
  -5.0956780781596935e-07,
  -2.3418252840991944e-08,
  1.1739029970314618e-09,
  -1.3504841689382374e-11,
  -4.7312154194401046e-13,
  1.9967361097883440e-14,
  9.8284959109612813e-01,
  6.8537887894587705e-03,
  -6.0968539575361196e-04,
  2.9749200815665233e-05,
  -7.3322035180067859e-07,
  -9.2340658999420790e-10,
  6.7460035335642485e-10,
  -1.9347123902946350e-11,
  5.7820415122478148e-14,
  1.1746159600534156e-14,
  9.9267151045478885e-01,
  3.2082567900274307e-03,
  -3.2133019004727538e-04,
  1.8572844776887364e-05,
  -6.3139586852223313e-07,
  9.2460490062678747e-09,
  2.0044336190849777e-10,
  -1.3490053518694368e-11,
  2.5540680681501726e-13,
  2.9809488211185455e-15,
  9.9711190860240939e-01,
  1.3725549271982995e-03,
  -1.5243145964816129e-04,
  1.0099621408388160e-05,
  -4.2414671224122459e-07,
  1.0453104774734574e-08,
  -6.3188487775533991e-11,
  -5.5647930707891643e-12,
  2.1531665339580287e-13,
  -1.1657341758564144e-15,
  9.9925588754460060e-01,
  7.1094905455977293e-04,
  -1.7364462191347130e-04,
  2.6611091839656709e-05,
  -2.7609039429221658e-06,
  1.9530738550082227e-07,
  -8.5498112478710198e-09,
  1.0219807222711097e-10,
  1.5055356961113376e-11,
  -1.1745826533626769e-12,
  9.9992429664840898e-01,
  7.9952607790545469e-05,
  -2.2454092124046810e-05,
  4.0836018863288356e-06,
  -5.2434605106732586e-07,
  4.9374410274145636e-08,
  -3.4177216612363281e-09,
  1.6530321556018635e-10,
  -4.3771319901964031e-12,
  -6.5514260683130490e-14,
  9.9999437279145464e-01,
  6.4450122683190614e-06,
  -2.0312962708324277e-06,
  4.2393553991715292e-07,
  -6.3991727916601349e-08,
  7.3213259770513599e-09,
  -6.4959034817846375e-10,
  4.4830250622851509e-11,
  -2.3485102751408249e-12,
  8.6891605022287874e-14,
  9.9999969411183931e-01,
  3.7439568063568628e-07,
  -1.3007557790878367e-07,
  3.0456141209000973e-08,
  -5.2416453844017495e-09,
  6.9679609636906528e-10,
  -7.3678396717014039e-11,
  6.2968519287665004e-12,
  -4.3662851112458158e-13,
  2.5918156509874278e-14,
  9.9999998783263366e-01,
  1.5732988334349331e-08,
  -5.9429933862986674e-09,
  1.5356477867101148e-09,
  -2.9520822453221738e-10,
  4.4385290212552986e-11,
  -5.3877124983614518e-12,
  5.3976823011225863e-13,
  -4.4986236957811342e-14,
  4.7739590058881731e-15,
  9.9999999976330334e-01,
  4.0451677563169144e-10,
  -2.5785933388533521e-10,
  1.2695231532688923e-10,
  -4.9857351580584461e-11,
  1.6034223722107339e-11,
  -4.3095194079967311e-12,
  9.8385743996232114e-13,
  -1.9244605908852464e-13,
  3.3623104300772868e-14,
  9.9999999999992040e-01,
  1.3979928326079972e-13,
  -9.5390362275793455e-14,
  5.2136073236397354e-14,
  -2.2959412149248239e-14,
  9.2326907843991353e-15,
  -3.1974423109204509e-15,
  1.7541523789077474e-15,
  -2.4424906541753446e-16,
  1.6653345369377348e-15} ;

gfloat RVPM_GAUSS_FIT_INTERVALS_F[] = {
  0.0000000000000000e+00,
  1.9687499999999999e-01,
  3.9374999999999999e-01,
  5.9062499999999996e-01,
  7.8749999999999998e-01,
  9.8437500000000000e-01,
  1.1812499999999999e+00,
  1.3781249999999998e+00,
  1.5750000000000000e+00,
  1.7718750000000001e+00,
  1.9687500000000000e+00,
  2.1656249999999999e+00,
  2.3624999999999998e+00,
  2.5593749999999997e+00,
  2.7562499999999996e+00,
  3.1499999999999999e+00,
  3.5437500000000002e+00,
  3.9375000000000000e+00,
  4.3312499999999998e+00,
  4.7249999999999996e+00,
  5.5124999999999993e+00,
  6.2999999999999998e+00} ;
#else
gdouble RVPM_GAUSS_FIT_COEFFICIENTS[] = {
  1.7613787358103880e-03,
  2.6366884350949244e-03,
  1.0454675764299665e-03,
  1.6787491700789148e-04,
  -2.5264324554941617e-06,
  -2.4063469963328620e-07,
  3.0443457338380497e-09,
  2.0441077311708633e-10,
  -2.4439314287583170e-12,
  -1.2594270244747906e-13,
  2.1073202186725180e-02,
  1.8040106402925450e-02,
  2.6762966814901285e-03,
  9.4658574929273881e-05,
  -6.2064618110174720e-06,
  -1.1139027972558585e-07,
  7.0994546717134677e-09,
  6.9549355163900375e-11,
  -5.3884650214053311e-12,
  -2.7043298156392836e-14,
  8.0896591449807043e-02,
  4.2198615882500873e-02,
  3.1738064924145769e-03,
  -1.2901299030215751e-05,
  -6.6741289620031450e-06,
  6.2815226553950001e-08,
  6.6518463751052968e-09,
  -9.5514170184163302e-11,
  -4.2724671023286477e-12,
  8.1906703641720924e-14,
  1.8900768314985128e-01,
  6.5300767764975037e-02,
  2.4447615126319102e-03,
  -1.0211085790586826e-04,
  -4.1046827724988690e-06,
  1.7807069131840770e-07,
  2.5882601867310841e-09,
  -1.7448232858541247e-10,
  -4.8014647813232610e-13,
  1.1279727152313512e-13,
  3.3468622746598098e-01,
  7.9125446805685673e-02,
  9.4932768929731901e-04,
  -1.3756589543467701e-04,
  -3.1172204473239873e-07,
  1.8333409020875048e-07,
  -1.9534175998980886e-09,
  -1.3270843868262717e-10,
  2.7556457116162393e-12,
  5.7612248305360931e-14,
  4.9541431412724390e-01,
  8.0288758757094708e-02,
  -6.2161763768107112e-04,
  -1.1683256901100503e-04,
  2.6426624093689456e-06,
  1.0316235243001958e-07,
  -4.2380071507697183e-09,
  -2.7350954834304275e-11,
  3.3586078362901618e-12,
  -2.0342061368694430e-14,
  6.4716711335643518e-01,
  7.0547112187878167e-02,
  -1.7199401207048659e-03,
  -6.3625145540924244e-05,
  3.6851078647148761e-06,
  3.3164721045808589e-09,
  -3.6882404352844844e-09,
  5.7967197708563842e-11,
  1.7467916002544826e-12,
  -5.8211768738658525e-14,
  7.7277713799500702e-01,
  5.4712841020054449e-02,
  -2.1413356796775584e-03,
  -8.3020899384056435e-06,
  3.0219933119579600e-06,
  -6.1376968315401953e-08,
  -1.6010091696827544e-09,
  8.0459006124300464e-11,
  -2.5601742947856110e-13,
  -4.4203529725450605e-14,
  8.6526907802187802e-01,
  3.7902455551785771e-02,
  -1.9961057182320109e-03,
  2.8874008636403660e-05,
  1.5823438290096802e-06,
  -7.4969505702363048e-08,
  3.3840428237397189e-10,
  5.2777970882544879e-11,
  -1.2608802890667903e-12,
  -8.7096996281843534e-15,
  9.2643416965005954e-01,
  2.3641026085401105e-02,
  -1.5445926960533374e-03,
  4.3055934477043144e-05,
  2.5967414952754452e-07,
  -5.3794764352105287e-08,
  1.2387284753501148e-09,
  1.2336420773806368e-11,
  -1.1200040894721042e-12,
  1.5998313784848505e-14,
  9.6299836395755101e-01,
  1.3350638089545397e-02,
  -1.0331044579833914e-03,
  4.0270344158166435e-05,
  -5.0956780781596935e-07,
  -2.3418252840991944e-08,
  1.1739029970314618e-09,
  -1.3504841689382374e-11,
  -4.7312154194401046e-13,
  1.9967361097883440e-14,
  9.8284959109612813e-01,
  6.8537887894587705e-03,
  -6.0968539575361196e-04,
  2.9749200815665233e-05,
  -7.3322035180067859e-07,
  -9.2340658999420790e-10,
  6.7460035335642485e-10,
  -1.9347123902946350e-11,
  5.7820415122478148e-14,
  1.1746159600534156e-14,
  9.9267151045478885e-01,
  3.2082567900274307e-03,
  -3.2133019004727538e-04,
  1.8572844776887364e-05,
  -6.3139586852223313e-07,
  9.2460490062678747e-09,
  2.0044336190849777e-10,
  -1.3490053518694368e-11,
  2.5540680681501726e-13,
  2.9809488211185455e-15,
  9.9711190860240939e-01,
  1.3725549271982995e-03,
  -1.5243145964816129e-04,
  1.0099621408388160e-05,
  -4.2414671224122459e-07,
  1.0453104774734574e-08,
  -6.3188487775533991e-11,
  -5.5647930707891643e-12,
  2.1531665339580287e-13,
  -1.1657341758564144e-15,
  9.9925588754460060e-01,
  7.1094905455977293e-04,
  -1.7364462191347130e-04,
  2.6611091839656709e-05,
  -2.7609039429221658e-06,
  1.9530738550082227e-07,
  -8.5498112478710198e-09,
  1.0219807222711097e-10,
  1.5055356961113376e-11,
  -1.1745826533626769e-12,
  9.9992429664840898e-01,
  7.9952607790545469e-05,
  -2.2454092124046810e-05,
  4.0836018863288356e-06,
  -5.2434605106732586e-07,
  4.9374410274145636e-08,
  -3.4177216612363281e-09,
  1.6530321556018635e-10,
  -4.3771319901964031e-12,
  -6.5514260683130490e-14,
  9.9999437279145464e-01,
  6.4450122683190614e-06,
  -2.0312962708324277e-06,
  4.2393553991715292e-07,
  -6.3991727916601349e-08,
  7.3213259770513599e-09,
  -6.4959034817846375e-10,
  4.4830250622851509e-11,
  -2.3485102751408249e-12,
  8.6891605022287874e-14,
  9.9999969411183931e-01,
  3.7439568063568628e-07,
  -1.3007557790878367e-07,
  3.0456141209000973e-08,
  -5.2416453844017495e-09,
  6.9679609636906528e-10,
  -7.3678396717014039e-11,
  6.2968519287665004e-12,
  -4.3662851112458158e-13,
  2.5918156509874278e-14,
  9.9999998783263366e-01,
  1.5732988334349331e-08,
  -5.9429933862986674e-09,
  1.5356477867101148e-09,
  -2.9520822453221738e-10,
  4.4385290212552986e-11,
  -5.3877124983614518e-12,
  5.3976823011225863e-13,
  -4.4986236957811342e-14,
  4.7739590058881731e-15,
  9.9999999976330334e-01,
  4.0451677563169144e-10,
  -2.5785933388533521e-10,
  1.2695231532688923e-10,
  -4.9857351580584461e-11,
  1.6034223722107339e-11,
  -4.3095194079967311e-12,
  9.8385743996232114e-13,
  -1.9244605908852464e-13,
  3.3623104300772868e-14,
  9.9999999999992040e-01,
  1.3979928326079972e-13,
  -9.5390362275793455e-14,
  5.2136073236397354e-14,
  -2.2959412149248239e-14,
  9.2326907843991353e-15,
  -3.1974423109204509e-15,
  1.7541523789077474e-15,
  -2.4424906541753446e-16,
  1.6653345369377348e-15} ;

gdouble RVPM_GAUSS_FIT_INTERVALS[] = {
  0.0000000000000000e+00,
  1.9687499999999999e-01,
  3.9374999999999999e-01,
  5.9062499999999996e-01,
  7.8749999999999998e-01,
  9.8437500000000000e-01,
  1.1812499999999999e+00,
  1.3781249999999998e+00,
  1.5750000000000000e+00,
  1.7718750000000001e+00,
  1.9687500000000000e+00,
  2.1656249999999999e+00,
  2.3624999999999998e+00,
  2.5593749999999997e+00,
  2.7562499999999996e+00,
  3.1499999999999999e+00,
  3.5437500000000002e+00,
  3.9375000000000000e+00,
  4.3312499999999998e+00,
  4.7249999999999996e+00,
  5.5124999999999993e+00,
  6.2999999999999998e+00} ;
#endif

#define rvpm_recursion_chebyshev(_x,_Tn,_Tnm1)		    \
  do {							    \
    gdouble _tmp ;					    \
    _tmp = (_Tn) ; (_Tn) = 2.0*(_x)*(_Tn) - (_Tnm1) ;	    \
    (_Tnm1) = _tmp ;					    \
  } while (0)

gint RVPM_FUNCTION_NAME(rvpm_gaussian_gfunc)(RVPM_REAL x, RVPM_REAL *g,
					     RVPM_REAL *dg)

{
  gint i ;
  RVPM_REAL Tn, Tnm1, *C, t ;
#ifdef RVPM_SINGLE_PRECISION
  const gfloat *xi = RVPM_GAUSS_FIT_INTERVALS_F ;
  const gfloat *Ci = RVPM_GAUSS_FIT_COEFFICIENTS_F ;
#else /*RVPM_SINGLE_PRECISION*/
  const gdouble *xi = RVPM_GAUSS_FIT_INTERVALS ;
  const gdouble *Ci = RVPM_GAUSS_FIT_COEFFICIENTS ;
#endif /*RVPM_SINGLE_PRECISION*/
  
  if ( x >= RVPM_GAUSS_FIT_CUTOFF ) {
    *g = 1.0 ; *dg = 0.0 ; return 0 ;
  }

  g_assert(x >= 0.0) ;

  for ( i = 0 ; (i < RVPM_GAUSS_FIT_INTERVAL_NUMBER) &&
	  !(( x >= xi[i] && x < xi[i+1])) ; i ++ ) ;

  g_assert(x >= xi[i] && x < xi[i+1]) ;
  
  /* C = &(RVPM_GAUSS_FIT_COEFFICIENTS[i*RVPM_GAUSS_FIT_ORDER]) ; */
  C = &(Ci[i*RVPM_GAUSS_FIT_ORDER]) ;

  t =
    (x - 0.5*(xi[i+1] + xi[i+0]))/(0.5*(xi[i+1] - xi[i+0])) ;

  Tnm1 = 1.0 ; Tn = t ;

  *g = C[0] ; *dg = 4.0*x*x*exp(-x*x)/sqrt(M_PI) ;
  for ( i = 1 ; i < RVPM_GAUSS_FIT_ORDER ; i ++ ) {
    *g  += C[i]*Tn ;
    rvpm_recursion_chebyshev(t,Tn,Tnm1) ;
  }

  return 0 ;
}
